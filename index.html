<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSystem Pro - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e2a45 0%, #121a2e 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --hover-bg: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; scrollbar-width: thin; scrollbar-color: var(--accent-blue) transparent; }
        body { display: flex; height: 100vh; background: var(--bg-gradient); color: var(--text-main); overflow: hidden; }

        aside { width: 280px; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 30px 20px; font-size: 1.4rem; font-weight: 600; letter-spacing: 1px; background: linear-gradient(90deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-bottom: 1px solid var(--glass-border); }
        .nav-scroll { flex: 1; overflow-y: auto; padding: 20px 0; }
        .nav-group { padding: 20px 25px 10px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1.5px; }
        .nav-item { padding: 12px 25px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 12px; color: #cbd5e1; font-size: 0.95rem; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--hover-bg); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent); border-left-color: var(--accent-blue); color: var(--accent-blue); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        header { padding: 20px 40px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; height: 80px; background: rgba(0,0,0,0.1); }
        h2#page-title { font-weight: 300; font-size: 1.8rem; }
        .search-box input { background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 20px; width: 300px; outline: none; transition: 0.3s; }
        .search-box input:focus { border-color: var(--accent-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .content-area { flex: 1; padding: 30px; overflow: hidden; display: flex; flex-direction: column; }
        
        .card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .toolbar { padding: 20px 25px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: rgba(0,0,0,0.2); text-align: left; padding: 15px 25px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; position: sticky; top: 0; z-index: 10; }
        td { padding: 15px 25px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; }
        tr:hover { background: var(--hover-bg); }

        .btn { padding: 8px 20px; border-radius: 20px; border: none; cursor: pointer; background: var(--accent-blue); color: white; font-weight: 500; transition: 0.3s; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .pagination { padding: 15px; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 10px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; justify-content: center; align-items: center; }
        .modal { background: #1e293b; width: 500px; padding: 30px; border-radius: 16px; border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-height: 90vh; overflow-y: auto; color: white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; outline: none; }
        .form-group input:focus, .form-group select:focus { border-color: var(--accent-blue); }
        .error-msg { color: var(--accent-red); font-size: 0.8rem; margin-top: 5px; display: none; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 10px; overflow-y: auto; }
        .dash-card { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dash-card h3 { margin-bottom: 20px; font-weight: 400; color: var(--text-muted); }

        #calendar-wrapper { padding: 20px; background: var(--glass-bg); border-radius: 16px; height: 100%; border: 1px solid var(--glass-border); color: white; }
        .fc-theme-standard td, .fc-theme-standard th { border-color: var(--glass-border) !important; }
        .fc-col-header-cell-cushion, .fc-timegrid-slot-label-cushion { color: var(--text-muted) !important; }

        .toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: rgba(16, 185, 129, 0.9); backdrop-filter: blur(5px); color: white; border-radius: 12px; transform: translateY(100px); transition: 0.4s; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

<aside>
    <div class="brand">‚ö° –ú–µ–¥–°–∏—Å—Ç–µ–º–∞</div>
    <div class="nav-scroll" id="nav-container"></div>
</aside>

<main>
    <header>
        <h2 id="page-title">–î–∞—à–±–æ—Ä–¥</h2>
        <div class="search-box" id="search-container">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="handleSearch()">
        </div>
    </header>
    <div class="content-area" id="content-area"></div>
</main>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h3 id="modal-title" style="margin-bottom: 20px; font-weight: 300; font-size: 1.5rem;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
        <div id="data-form"></div>
        <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
            <button class="btn" style="background: transparent; border: 1px solid var(--glass-border);" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn" onclick="saveData()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">–£—Å–ø–µ—à–Ω–æ!</div>

<script>
    const API_URL = "http://127.0.0.1:8000";

    // --- –•–ï–õ–ü–ï–†–´ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---
    function formatDoctor(doc) {
        if (!doc) return '';
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≤ –∫—ç—à–µ
        const specs = referenceCache['/specializations/'] || [];
        const specName = specs.find(s => s.id === doc.specialization_id)?.name || '';
        return `${doc.last_name} ${doc.first_name.charAt(0)}. ${specName ? '(' + specName + ')' : ''}`;
    }

    function formatPatient(pat) {
        if (!pat) return '';
        const dob = pat.birth_date ? new Date(pat.birth_date).toLocaleDateString('ru-RU') : '';
        return `${pat.last_name} ${pat.first_name} ${dob ? '(' + dob + ')' : ''}`;
    }

    // --- –ü–û–õ–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–°–ï 14 –¢–ê–ë–õ–ò–¶) ---
    const SCHEMAS = {
        // 1. –ü–ï–†–°–û–ù–ê–õ
        doctors: {
            group: "–ü–µ—Ä—Å–æ–Ω–∞–ª", title: "–í—Ä–∞—á–∏", endpoint: "/doctors/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "last_name", label: "–§–∞–º–∏–ª–∏—è", type: "text" },
                { key: "first_name", label: "–ò–º—è", type: "text" },
                { key: "specialization_id", label: "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å", type: "select", lookup: "/specializations/", lookupKey: "name" },
                { key: "department_id", label: "–û—Ç–¥–µ–ª–µ–Ω–∏–µ", type: "select", lookup: "/departments/", lookupKey: "name" },
                { key: "category", label: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", type: "text" }
            ]
        },
        
        // 2. –ü–ê–¶–ò–ï–ù–¢–´
        patients: {
            group: "–ü–∞—Ü–∏–µ–Ω—Ç—ã", title: "–ü–∞—Ü–∏–µ–Ω—Ç—ã", endpoint: "/patients/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "last_name", label: "–§–∞–º–∏–ª–∏—è", type: "text" },
                { key: "first_name", label: "–ò–º—è", type: "text" },
                { key: "birth_date", label: "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", type: "date" },
                { key: "phone", label: "–¢–µ–ª–µ—Ñ–æ–Ω", type: "tel" },
                { key: "policy_id", label: "–ü–æ–ª–∏—Å", type: "select", lookup: "/policies/", lookupKey: "policy_number" }
            ]
        },
        insurance_policies: {
            group: "–ü–∞—Ü–∏–µ–Ω—Ç—ã", title: "–°—Ç—Ä–∞—Ö–æ–≤—ã–µ –ø–æ–ª–∏—Å—ã", endpoint: "/policies/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "policy_number", label: "–ù–æ–º–µ—Ä –ø–æ–ª–∏—Å–∞", type: "text" },
                { key: "company_name", label: "–ö–æ–º–ø–∞–Ω–∏—è", type: "text" },
                { key: "expiration_date", label: "–ì–æ–¥–µ–Ω –¥–æ", type: "date" }
            ]
        },

        // 3. –ü–†–û–¶–ï–°–°–´
        appointments: {
            group: "–ü—Ä–æ—Ü–µ—Å—Å—ã", title: "–ñ—É—Ä–Ω–∞–ª –∑–∞–ø–∏—Å–µ–π", endpoint: "/appointments/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "patient_id", label: "–ü–∞—Ü–∏–µ–Ω—Ç", type: "select", lookup: "/patients/", formatFunc: 'patient' },
                { key: "doctor_id", label: "–í—Ä–∞—á", type: "select", lookup: "/doctors/", formatFunc: 'doctor' },
                { key: "datetime", label: "–í—Ä–µ–º—è –ø—Ä–∏–µ–º–∞", type: "datetime-local" },
                { key: "status_id", label: "–°—Ç–∞—Ç—É—Å", type: "select", lookup: "/statuses/", lookupKey: "name" }
            ]
        },
        schedule: {
            group: "–ü—Ä–æ—Ü–µ—Å—Å—ã", title: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", endpoint: "/schedules/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "doctor_id", label: "–í—Ä–∞—á", type: "select", lookup: "/doctors/", formatFunc: 'doctor' },
                { key: "cabinet_id", label: "–ö–∞–±–∏–Ω–µ—Ç", type: "select", lookup: "/cabinets/", lookupKey: "number" },
                { key: "day_of_week", label: "–î–µ–Ω—å (1-7)", type: "number" },
                { key: "start_time", label: "–ù–∞—á–∞–ª–æ", type: "time" },
                { key: "end_time", label: "–ö–æ–Ω–µ—Ü", type: "time" }
            ]
        },

        // 4. –õ–ï–ß–ï–ù–ò–ï
        medical_records: {
            group: "–õ–µ—á–µ–Ω–∏–µ", title: "–ú–µ–¥–∫–∞—Ä—Ç—ã", endpoint: "/medical_records/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "appointment_id", label: "ID –ó–∞–ø–∏—Å–∏", type: "number" },
                { key: "complaints", label: "–ñ–∞–ª–æ–±—ã", type: "text" },
                { key: "diagnosis_id", label: "–î–∏–∞–≥–Ω–æ–∑", type: "select", lookup: "/diagnoses/", lookupKey: "description" },
                { key: "recommendations", label: "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", type: "text" }
            ]
        },
        prescriptions: {
            group: "–õ–µ—á–µ–Ω–∏–µ", title: "–†–µ—Ü–µ–ø—Ç—ã", endpoint: "/prescriptions/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "record_id", label: "ID –ú–µ–¥–∫–∞—Ä—Ç—ã", type: "number" },
                { key: "drug_name", label: "–ü—Ä–µ–ø–∞—Ä–∞—Ç", type: "text" },
                { key: "dosage", label: "–î–æ–∑–∏—Ä–æ–≤–∫–∞", type: "text" },
                { key: "duration_days", label: "–î–Ω–µ–π", type: "number" }
            ]
        },
        services_rendered: {
            group: "–õ–µ—á–µ–Ω–∏–µ", title: "–û–∫–∞–∑–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏", endpoint: "/services_rendered/",
            fields: [
                { key: "id", label: "ID", type: "readonly" },
                { key: "record_id", label: "ID –ú–µ–¥–∫–∞—Ä—Ç—ã", type: "number" },
                { key: "service_id", label: "–£—Å–ª—É–≥–∞", type: "select", lookup: "/services/", lookupKey: "name" },
                { key: "quantity", label: "–ö–æ–ª-–≤–æ", type: "number" }
            ]
        },

        // 5. –°–ü–†–ê–í–û–ß–ù–ò–ö–ò
        departments: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–û—Ç–¥–µ–ª–µ–Ω–∏—è", endpoint: "/departments/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "name", label: "–ù–∞–∑–≤–∞–Ω–∏–µ", type: "text" }] },
        specializations: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏", endpoint: "/specializations/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "name", label: "–ù–∞–∑–≤–∞–Ω–∏–µ", type: "text" }] },
        cabinets: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–ö–∞–±–∏–Ω–µ—Ç—ã", endpoint: "/cabinets/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "number", label: "–ù–æ–º–µ—Ä", type: "text" }, { key: "floor", label: "–≠—Ç–∞–∂", type: "number" }, { key: "department_id", label: "–û—Ç–¥–µ–ª–µ–Ω–∏–µ", type: "select", lookup: "/departments/", lookupKey: "name" }] },
        service_catalog: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–ö–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥", endpoint: "/services/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "name", label: "–ù–∞–∑–≤–∞–Ω–∏–µ", type: "text" }, { key: "price", label: "–¶–µ–Ω–∞", type: "number" }] },
        diagnoses: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–î–∏–∞–≥–Ω–æ–∑—ã (–ú–ö–ë)", endpoint: "/diagnoses/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "mkb_code", label: "–ö–æ–¥", type: "text" }, { key: "description", label: "–û–ø–∏—Å–∞–Ω–∏–µ", type: "text" }] },
        statuses: { group: "–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏", title: "–°—Ç–∞—Ç—É—Å—ã", endpoint: "/statuses/", fields: [{ key: "id", label: "ID", type: "readonly" }, { key: "name", label: "–ù–∞–∑–≤–∞–Ω–∏–µ", type: "text" }] }
    };

    // STATE
    let currentTab = null;
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 10;
    let referenceCache = {};
    let currentEditId = null;

    // --- INIT ---
    function renderSidebar() {
        const container = document.getElementById('nav-container');
        let html = `<div class="nav-group">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
            <div class="nav-item" id="nav-dashboard" onclick="openDashboard()"><span>üìä</span> –î–∞—à–±–æ—Ä–¥</div>
            <div class="nav-item" id="nav-calendar" onclick="openCalendar()"><span>üìÖ</span> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>`;

        const groups = {};
        for (const [key, schema] of Object.entries(SCHEMAS)) {
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ø–æ–ª–µ group (–≤—Å–µ –Ω–∞—à–∏ —Ç–∞–±–ª–∏—Ü—ã)
            if (schema.group) {
                if (!groups[schema.group]) groups[schema.group] = [];
                groups[schema.group].push({ key, title: schema.title });
            }
        }
        for (const [groupName, items] of Object.entries(groups)) {
            html += `<div class="nav-group">${groupName}</div>`;
            items.forEach(item => {
                html += `<div class="nav-item" id="nav-${item.key}" onclick="switchTab('${item.key}')"><span>üìÑ</span> ${item.title}</div>`;
            });
        }
        container.innerHTML = html;
    }

    function setActiveNav(id) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const el = document.getElementById(id);
        if (el) el.classList.add('active');
        document.getElementById('search-container').style.visibility = (id === 'nav-dashboard' || id === 'nav-calendar') ? 'hidden' : 'visible';
    }

    // --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
    async function preloadReferences(schema) {
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–π —Å—Ö–µ–º—ã
        let lookups = schema.fields
            .filter(f => f.lookup)
            .map(f => f.lookup);
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –ó–ê–ü–ò–°–ï–ô, —Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≥—Ä—É–∑–∏–º –∏ –≤—Ä–∞—á–µ–π, –∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤, –∏ —Å—Ç–∞—Ç—É—Å—ã, –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (schema.endpoint === '/appointments/' || currentTab === 'calendar') {
            lookups.push('/doctors/', '/patients/', '/statuses/', '/specializations/');
        }
        // –î–ª—è —Ç–∞–±–ª–∏—Ü—ã –í–†–ê–ß–ï–ô –≥—Ä—É–∑–∏–º –æ—Ç–¥–µ–ª—ã –∏ —Å–ø–µ—Ü
        if (schema.endpoint === '/doctors/') {
            lookups.push('/specializations/', '/departments/');
        }

        lookups = [...new Set(lookups)]; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—ë
        await Promise.all(lookups.map(async url => {
            // –ì—Ä—É–∑–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ, –ò–õ–ò –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (–≤—Ä–∞—á–∏/–ø–∞—Ü–∏–µ–Ω—Ç—ã)
            if (!referenceCache[url] || url === '/doctors/' || url === '/patients/') {
                try {
                    const res = await fetch(API_URL + url);
                    if (res.ok) referenceCache[url] = await res.json();
                } catch (e) { console.error("Error loading", url); }
            }
        }));
    }

    // --- DASHBOARD ---
    async function openDashboard() {
        currentTab = 'dashboard';
        setActiveNav('nav-dashboard');
        document.getElementById('page-title').textContent = "–û–±–∑–æ—Ä –∫–ª–∏–Ω–∏–∫–∏";
        document.getElementById('content-area').innerHTML = `<div class="dashboard-grid">
                <div class="dash-card"><h3>–ó–∞–ø–∏—Å–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3><canvas id="chartStatuses"></canvas></div>
                <div class="dash-card"><h3>–¢–æ–ø –≤—Ä–∞—á–µ–π</h3><canvas id="chartDoctors"></canvas></div>
            </div>`;
        try {
            const [appointments, statuses, doctors] = await Promise.all([
                 fetch(API_URL + "/appointments/").then(r => r.json()),
                 fetch(API_URL + "/statuses/").then(r => r.json()),
                 fetch(API_URL + "/doctors/").then(r => r.json())
            ]);
            const sCounts = {}; 
            appointments.forEach(a => { const n = statuses.find(s => s.id === a.status_id)?.name || "N/A"; sCounts[n] = (sCounts[n] || 0) + 1; });
            new Chart(document.getElementById('chartStatuses'), { type: 'doughnut', data: { labels: Object.keys(sCounts), datasets: [{ data: Object.values(sCounts), backgroundColor: ['#3b82f6', '#10b981', '#ef4444'] }] } });
            const dCounts = {};
            appointments.forEach(a => { 
                const doc = doctors.find(d => d.id === a.doctor_id);
                const name = doc ? doc.last_name : '–£–¥–∞–ª–µ–Ω';
                dCounts[name] = (dCounts[name] || 0) + 1; 
            });
            new Chart(document.getElementById('chartDoctors'), { type: 'bar', data: { labels: Object.keys(dCounts), datasets: [{ label: '–ü—Ä–∏–µ–º–æ–≤', data: Object.values(dCounts), backgroundColor: '#3b82f6' }] } });
        } catch(e) {}
    }

    // --- CALENDAR (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) ---
    async function openCalendar() {
        currentTab = 'calendar';
        setActiveNav('nav-calendar');
        document.getElementById('page-title').textContent = "–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–µ–º–æ–≤";
        document.getElementById('content-area').innerHTML = `<div id="calendar-wrapper"><div id="calendar"></div></div>`;
        
        // 1. –ì—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
        const [appointments, doctors, patients, statuses] = await Promise.all([
            fetch(API_URL + "/appointments/").then(r => r.json()),
            fetch(API_URL + "/doctors/").then(r => r.json()),
            fetch(API_URL + "/patients/").then(r => r.json()),
            fetch(API_URL + "/statuses/").then(r => r.json())
        ]);

        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à, —á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∞ –≤–∏–¥–µ–ª–∞ –∏—Ö –°–†–ê–ó–£
        referenceCache['/doctors/'] = doctors;
        referenceCache['/patients/'] = patients;
        referenceCache['/statuses/'] = statuses;
        
        // 3. –ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Ñ—É–Ω–∫—Ü–∏—è formatDoctor –Ω–µ –ø–∞–¥–∞–ª–∞
        await preloadReferences(SCHEMAS['appointments']);

        const events = appointments.map(appt => {
            const doc = doctors.find(d => d.id === appt.doctor_id);
            const pat = patients.find(p => p.id === appt.patient_id);
            return {
                id: appt.id,
                title: `${doc?.last_name || '?'} - ${pat?.last_name || '?'}`,
                start: appt.datetime,
                end: new Date(new Date(appt.datetime).getTime() + 30*60000), // +30 –º–∏–Ω
                extendedProps: { fullAppt: appt },
                color: '#3b82f6'
            };
        });

        const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'timeGridWeek', locale: 'ru',
            slotMinTime: "08:00:00", slotMaxTime: "20:00:00",
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
            events: events, height: '100%',
            
            // –ö–ª–∏–∫ –Ω–∞ —Å–æ–±—ã—Ç–∏–µ (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            eventClick: async info => { 
                // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Å—Ö–µ–º—É 'appointments', —Ç–∞–∫ –∫–∞–∫ currentTab = 'calendar'
                await openModal(info.event.extendedProps.fullAppt, 'appointments'); 
            },
            
            // –ö–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É (–°–æ–∑–¥–∞–Ω–∏–µ)
            dateClick: async info => {
                const newAppt = { datetime: info.dateStr.slice(0, 16) };
                await openModal(newAppt, 'appointments');
            }
        });
        calendar.render();
    }

    // --- TABLES ---
    async function switchTab(key) {
        currentTab = key;
        setActiveNav(`nav-${key}`);
        document.getElementById('page-title').textContent = SCHEMAS[key].title;
        document.getElementById('content-area').innerHTML = `
            <div class="card">
                <div class="toolbar">
                    <span style="color: var(--text-muted);">–í—Å–µ–≥–æ: <span id="total-count">...</span></span>
                    <button class="btn" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div class="table-container"><table id="data-table"><thead></thead><tbody></tbody></table></div>
                <div class="pagination">
                    <button class="btn" style="background:transparent; border:1px solid var(--glass-border)" onclick="prevPage()">‚ùÆ</button>
                    <button class="btn" style="background:transparent; border:1px solid var(--glass-border)" onclick="nextPage()">‚ùØ</button>
                </div>
            </div>`;
        
        await preloadReferences(SCHEMAS[key]);
        await loadData();
    }

    async function loadData() {
        try {
            const res = await fetch(API_URL + SCHEMAS[currentTab].endpoint);
            allData = await res.json();
            filteredData = [...allData];
            currentPage = 1;
            renderTable();
        } catch(e) {}
    }

    function getFormattedValue(item, f) {
        let val = item[f.key];
        if (f.lookup && referenceCache[f.lookup]) {
            const refItem = referenceCache[f.lookup].find(r => r.id === val);
            if (refItem) {
                if (f.formatFunc === 'doctor') return formatDoctor(refItem);
                if (f.formatFunc === 'patient') return formatPatient(refItem);
                return refItem[f.lookupKey] || val;
            }
        }
        if (f.type === 'datetime-local' && val) val = new Date(val).toLocaleString('ru-RU');
        return val || '-';
    }

    function renderTable() {
        const thead = document.querySelector('#data-table thead');
        let headHtml = '<tr>';
        SCHEMAS[currentTab].fields.forEach(f => headHtml += `<th>${f.label}</th>`);
        headHtml += '<th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
        thead.innerHTML = headHtml;

        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const pageData = filteredData.slice(start, start + ITEMS_PER_PAGE);
        document.getElementById('total-count').textContent = filteredData.length;

        pageData.forEach(item => {
            const tr = document.createElement('tr');
            let html = '';
            SCHEMAS[currentTab].fields.forEach(f => html += `<td>${getFormattedValue(item, f)}</td>`);
            html += `<td style="text-align:right">
                <button style="background:none; border:none; color: var(--accent-blue); cursor:pointer;" onclick='openModal(${JSON.stringify(item)})'>‚úèÔ∏è</button>
                <button style="background:none; border:none; color: var(--accent-red); cursor:pointer;" onclick="deleteItem(${item.id})">‚úñ</button>
            </td>`;
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    // --- FORMS (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –û–¢–ö–†–´–¢–ò–ï) ---
    async function openModal(item = null, schemaKey = null) {
        // –ï—Å–ª–∏ schemaKey –ø–µ—Ä–µ–¥–∞–Ω (–∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ. –ò–Ω–∞—á–µ –±–µ—Ä–µ–º currentTab.
        const activeKey = schemaKey || currentTab;
        const schema = SCHEMAS[activeKey];
        
        // 1. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –ü–ï–†–ï–î —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º —Ñ–æ—Ä–º—ã
        await preloadReferences(schema);

        currentEditId = item ? item.id : null;
        document.getElementById('modal-title').textContent = item && item.id ? "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : "–°–æ–∑–¥–∞–Ω–∏–µ";
        const container = document.getElementById('data-form');
        container.innerHTML = '';

        schema.fields.forEach(f => {
            if (f.type === 'readonly') return;
            let val = item ? item[f.key] : '';
            if (f.type === 'datetime-local' && val) val = val.slice(0, 16);

            const div = document.createElement('div');
            div.className = 'form-group';
            let inputHtml = '';
            
            if (f.lookup) {
                // –ó–¥–µ—Å—å –¥–∞–Ω–Ω—ã–µ –£–ñ–ï –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ referenceCache
                const opts = referenceCache[f.lookup] || [];
                const optionsHtml = opts.map(o => {
                    let label = o[f.lookupKey];
                    if (f.formatFunc === 'doctor') label = formatDoctor(o);
                    if (f.formatFunc === 'patient') label = formatPatient(o);
                    return `<option value="${o.id}" ${o.id == val ? 'selected' : ''}>${label}</option>`;
                }).join('');
                
                inputHtml = `<select id="field-${f.key}">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    ${optionsHtml}
                </select>`;
            } else {
                inputHtml = `<input type="${f.type === 'number' ? 'number' : (f.type === 'date' ? 'date' : (f.type === 'datetime-local' ? 'datetime-local' : 'text'))}" id="field-${f.key}" value="${val || ''}">`;
            }
            div.innerHTML = `<label>${f.label}</label>${inputHtml}<div class="error-msg" id="err-${f.key}"></div>`;
            container.appendChild(div);
            
            if (f.type === 'tel') Inputmask({ "mask": "+7 (999) 999-99-99" }).mask(div.querySelector('input'));
        });
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function saveData() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ö–µ–º—É (–¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è —ç—Ç–æ appointments)
        const schemaKey = (currentTab === 'calendar') ? 'appointments' : currentTab;
        const schema = SCHEMAS[schemaKey];
        
        const data = {};
        let hasError = false;

        schema.fields.forEach(f => {
            if (f.type === 'readonly') return;
            const el = document.getElementById(`field-${f.key}`);
            if (!el) return;
            let val = el.value;
            if (val === "" || val.trim() === "") val = null;
            
            if (f.type === 'tel' && val && val.includes('_')) {
                 const err = document.getElementById(`err-${f.key}`);
                 if(err) { err.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"; err.style.display = 'block'; }
                 hasError = true;
            }
            data[f.key] = val;
        });

        if (hasError) return;
        Object.keys(data).forEach(k => { if(data[k]===null) delete data[k]; });

        const method = currentEditId ? 'PATCH' : 'POST';
        const url = API_URL + schema.endpoint + (currentEditId ? currentEditId : '');
        
        try {
            const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            if (res.ok) {
                closeModal();
                showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                if (currentTab === 'calendar') openCalendar(); else loadData();
            } else {
                const err = await res.json();
                alert("–û—à–∏–±–∫–∞: " + JSON.stringify(err));
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
    }

    async function deleteItem(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
        try {
            await fetch(API_URL + SCHEMAS[currentTab].endpoint + id, { method: 'DELETE' });
            showToast("–£–¥–∞–ª–µ–Ω–æ");
            loadData();
        } catch(e) {}
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(()=>t.classList.remove('show'), 3000);
    }

    function handleSearch() {
        const q = document.getElementById('search-input').value.toLowerCase();
        filteredData = allData.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(q)));
        currentPage = 1;
        renderTable();
    }
    function prevPage() { if(currentPage > 1) { currentPage--; renderTable(); } }
    function nextPage() { if(currentPage * ITEMS_PER_PAGE < filteredData.length) { currentPage++; renderTable(); } }

    renderSidebar();
    openDashboard();
</script>
</body>
</html>
